var Promise = require('lie');
var readconf = require('lib/readconf');
var c = require('chalk');
var _ = { each: require('lodash.foreach') };
// ----------------------------------------------------------------------------

module.exports = function (cwd, args, draftdir) {
	var conf = readconf(cwd, '.valkyrja');

	if (args.length == 0) {
		console.log(c.red('valkyrja') + ': you must specify a file to diff');
	}

	var filepath = args.shift();

	var targetCategory = false;
	if (args.length > 0) {
		targetCategory = args.shift();
	}

	console.log(c.red.dim("Unfortunately") + ", file diffs are currently not supported");
	console.log("Here are equivalent commands for what you requested:");
	console.log('');

	var alldiffs = new Promise(function (done, failed) {
		var tasks = [];
		var nextTask = function () {
			if (tasks.length > 0) {
				var task = tasks.shift();
				task().then(nextTask, failed);
			}
			else { // finished
				done();
			}
		}

		_.each(conf.servers, function (hosts, category) {
			if ( ! targetCategory || targetCategory == category) {
				_.each(hosts, function (host) {
					tasks.push(function () {
						return new Promise(function (resolve, reject) {
							console.log("diff '"+filepath+"' <(ssh "+host.username+"@"+host.host+" 'cat "+host.path.replace(/\/$/, '')+"/"+filepath+"')");
							resolve();
						});
					})
				});
			}
		});

		nextTask();
	});

	alldiffs.then(function () {
		console.log('');
		// console.log(c.blue('diff complete'));
		console.log('');
	}, function (reason) {
		if (reason) {
			if (reason.stack) {
				console.log('')
				console.log(reason.stack);
			}
			else { // non stack error
				console.log(reason);
			}
		}

		console.log('');
		console.log(c.red.dim('diff failed'));
		console.log('');
	})
}
