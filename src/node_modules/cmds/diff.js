var Promise = require('lie');
var readconf = require('lib/readconf');
var readtools = require('lib/readtools');
var rsyncEach = require('lib/rsyncEach');
var c = require('chalk');
// ----------------------------------------------------------------------------

module.exports = function (cwd, args, draftdir) {
	var conf = readconf(cwd, '.valkyrja');
	var tools = readtools(cwd, '.valkyrja');

	if (args.length == 0) {
		console.log(c.red('valkyrja') + ': server category required');
	}

	var category = args.shift();

	rsyncEach(cwd, conf, category, tools, function (rsync, ssh, host) {
		rsync.set('dry-run');
		ssh.disable();

		tools.confdiff(cwd, args, conf, rsync, ssh, host);

	}, { simple: true, check: false, build: false })
	.then(function () {
		console.log('');
	}, function (reason) {
		console.log(c.gray('[') + ' ' + c.red('diff failed') + ' ' + c.gray(']'));
		if (reason) {
			console.log('');
			if (reason.stack) {
				console.log(reason.stack)
			}
			else { // no stack
				console.log(reason);
			}
			console.log('');
		}

		return Promise.reject();
	});
}
