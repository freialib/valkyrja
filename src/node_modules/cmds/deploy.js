var Promise = require('lie');
var readconf = require('lib/readconf');
var readtools = require('lib/readtools');
var rsyncEach = require('lib/rsyncEach');
var c = require('chalk');
// ----------------------------------------------------------------------------

module.exports = function (cwd, args, draftdir) {
	var conf = readconf(cwd, '.valkyrja');
	var tools = readtools(cwd, '.valkyrja');

	if (args.length == 0) {
		console.log('server category required');
	}

	console.log('');
	console.log(c.gray('[') + ' ' + c.blue('starting transmission') + ' ' + c.gray(']'))

	rsyncEach(cwd, conf, args[0], tools, function (rsync, ssh, host) {
		tools.confdeploy(cwd, args, conf, rsync, ssh, host);
	})
	.then(function () {
		console.log(c.gray('[') + ' ' + c.blue('deploy succesful') + ' ' + c.gray(']'));
		console.log('');
	}, function (reason) {
		console.log(c.gray('[') + ' ' + c.red.dim('deploy failed') + ' ' + c.gray(']'));
		console.log('');
		if (reason != null) {
			if (reason.stack) {
				console.log(reason.stack)
				console.log('');
			}
			else { // no stack
				console.log(reason)
				console.log('');
			}
		}

		return Promise.reject();
	});
}
