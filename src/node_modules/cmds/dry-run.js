var Promise = require('lie');
var readconf = require('lib/readconf');
var readtools = require('lib/readtools');
var rsyncEach = require('lib/rsyncEach');
var c = require('chalk');
// ----------------------------------------------------------------------------

module.exports = function (cwd, args, draftdir) {
	var conf = readconf(cwd, '.valkyrja');
	var tools = readtools(cwd, '.valkyrja');

	if (args.length == 0) {
		console.log('server category required');
	}

	console.log('');
	console.log(c.gray('[') + ' ' + c.blue('starting simulation') + ' ' + c.gray(']'))

	rsyncEach(cwd, conf, args[0], tools, function (rsync, ssh, host) {
		rsync.set('dry-run');
		ssh.dryrun();

		tools.confdryrun(conf, rsync, ssh, host);
	}, { printcmd: true })
	.then(function () {
		console.log(c.gray('[') + ' ' + c.blue('simulation finished') + ' ' + c.gray(']'));
		console.log('');
	}, function (reason) {
		console.log(c.gray('[') + ' ' + c.red('simulation failed') + ' ' + c.gray(']'));
		if (reason) {
			console.log('');
			if (reason.stack) {
				console.log(reason.stack)
			}
			else { // no stack
				console.log(reason);
			}
			console.log('');
		}

		return Promise.reject();
	});
}
